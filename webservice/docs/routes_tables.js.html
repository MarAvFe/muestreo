<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes/tables.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes/tables.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var express = require("express");
var conf = require("../../conf/default.json").mysql;

/**
 * Get all the available table descriptions in the database.
 * @function tables
 */

exports.router = function(connection) {

    var router = express.Router();

    var get = express.Router();
    get.post("/get", function(req, res) {
		//table list request
        connection.query("SHOW TABLES;", {}, setTableNames(connection, res, conf.database));
    });
    router.use("/tables", get);


    return router;
}


var setTableNames = function(connection, res, db) {

    return {
        json: function(obj) {
            var tempObject = {
                tables: []
            };
            var size = obj.data.length;
            for (i = 0; i &lt; obj.data.length; i++) {
                var table = obj.data[i]["Tables_in_" + db];
				//table description request
                connection.query("DESCRIBE " + table + " ;", {}, setTableDescription(connection, res, tempObject, table, size));
            }
        }
    }
}

var setTableDescription = function(connection, res, tempObject, table, size) {
    return {
        json: function(obj) {
            var tableDescription = {
                name: table,
                fields: obj.data
            };
			//foreign keys request
            connection.query("SELECT CONSTRAINT_NAME, COLUMN_NAME, REFERENCED_TABLE_NAME, REFERENCED_COLUMN_NAME FROM information_schema.KEY_COLUMN_USAGE WHERE TABLE_NAME = '" + table + "' AND REFERENCED_TABLE_NAME IS NOT NULL;", {}, setForeignKeys(res, tempObject, tableDescription, size));
        }
    }
}

var setForeignKeys = function(res, tempObject, tableDescription, size) {
    return {
        json: function(obj) {

			//add foreign key information if the table has foreign keys
            if (tableDescription.fields) {
                for (i1 = 0; i1 &lt; obj.data.length; i1++) {
                    for (i2 = 0; i2 &lt; tableDescription.fields.length; i2++) {
						//add the foreign key data to the field object if it matches with some of the table columns
                        if (tableDescription.fields[i2].Field == obj.data[i1].COLUMN_NAME) {
                            tableDescription.fields[i2].ForeignKey = obj.data[i1];
                        }
                    }
                }
            }

            tempObject.tables.push(tableDescription);

            if (tempObject.tables.length == size) {
                //when all tables have been added
                res.json(tempObject);
            }
        }
    }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="app.html">app</a></li><li><a href="dbConnection.html">dbConnection</a></li><li><a href="logger.html">logger</a></li><li><a href="route.html">route</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Comments">Comments</a></li><li><a href="global.html#getImprodActs">getImprodActs</a></li><li><a href="global.html#Group_has_Trail">Group_has_Trail</a></li><li><a href="global.html#ImprodAct">ImprodAct</a></li><li><a href="global.html#Observation">Observation</a></li><li><a href="global.html#procedures">procedures</a></li><li><a href="global.html#router">router</a></li><li><a href="global.html#Sampling">Sampling</a></li><li><a href="global.html#Sampling_has_Comments">Sampling_has_Comments</a></li><li><a href="global.html#Sampling_has_Group">Sampling_has_Group</a></li><li><a href="global.html#SamplingType">SamplingType</a></li><li><a href="global.html#tables">tables</a></li><li><a href="global.html#Trail">Trail</a></li><li><a href="global.html#Trail_has_Observation">Trail_has_Observation</a></li><li><a href="global.html#User">User</a></li><li><a href="global.html#User_has_Sampling">User_has_Sampling</a></li><li><a href="global.html#Worker">Worker</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Sep 16 2017 04:55:17 GMT-0600 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
